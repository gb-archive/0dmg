Big refactoring into a few pieces. Still tightly-coupled, but more well-organized.
