<!doctype html>
<html>
<head>
  <title>0dmg</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="https://cdn.glitch.com/24a0763e-f0ea-48ec-aeb1-31b95e3ab0fa%2Fgb.png?1527567414683" />
</head>  
<body>
  <zerodmg-gameboy>
    <div class="frame">
      <canvas class="display" width="160" height="144"></canvas>
    </div>

    <div class="power-light"></div>
    
    <div class="controls">
      <div class="arrow-filler"></div>
      <button class="arrowleft-button">◀</button>
      <button class="arrowright-button">▶</button>
      <button class="arrowup-button">▲</button>
      <button class="arrowdown-button">▼</button>

      <button class="a-button">A</button>
      <button class="b-button">B</button>

      <button class="space-button">SELECT</button>
      <button class="enter-button">START</button>
      </div>
    </div>
  </zerodmg-gameboy><zerodmg-internals>
    <section>
      <h1>
        background 1
      </h1>
      <canvas class="background-1" width="256" height="256"></canvas>
    </section>
    <section>
      <h1>
        tiles
      </h1>
      <canvas class="tiles" width="143" height="143"></canvas>
    </section>
    <section>
        <h1>
          background 2
        </h1>
        <canvas class="background-2" width="256" height="256"></canvas>
      </section>
    <section>
      <h1>
        palettes
      </h1>
      
      <section>
        <h2>
          background
        </h2>
        <canvas class="bgp" width="4" height="1"></canvas>
      </section>

      <section>
        <h2>
          object 1
        </h2>
        <canvas class="obj1" width="3" height="1"></canvas>
      </section>

      <section>
        <h2>
          object 2
        </h2>
        <canvas class="obj2" width="3" height="1"></canvas>
      </section>

      <h1>
        sprites
      </h1>
      <canvas class="sprites" width="84" height="71"></canvas>
    </section>
  </zerodmg-internals>

  <style>
    html {
      background: #000;
      text-align: center;
      font-family: monospace;
    }
    zerodmg-internals {
      margin-top: 14px;
      background: #b4df6a;
      border: 4px outset #89b344;
      border-radius: 12px;
      border-top-left-radius: 4px;
      border-bottom-left-radius: 4px;
      border-left: 0;
      position: relative;
      left: -2px;
      z-index: 200;
      display: inline-block;
      vertical-align: top;
      text-align: left;
      padding: 8px;
      padding-top: 0;
      position: relative;
      width: 512px;
      box-shadow: 0 0 1px 1px rgba(0, 0, 0, 0.75);
    }
    zerodmg-internals a {
      color: inherit;
    }
    zerodmg-internals input,
    zerodmg-internals textarea {
      font: inherit;
      background: #c7e6bb;
      padding: 4px;
      border: 4px inset #443;
      width: 127px;
    }
    zerodmg-internals input {
      text-align: right;
    }
    zerodmg-internals textarea {
      width: 192px;
    }
    zerodmg-internals > section {
      display: inline-block;
      width: auto;
      vertical-align: top;
      margin-left: 4px;
    }
    zerodmg-internals > section section {
      display: inline-block;
      width: auto;
    }
    zerodmg-internals > section section input {
      display: inline-block;
      width: 48px;
    }
    zerodmg-internals h1 {
      font-size: 16px;
      margin: 0;
      margin-top: 5px;
      padding-left: 4px;
    }
    zerodmg-internals h2 {
      font-size: 12px;
      font-weight: normal;
      margin: 0;
      margin-top: 2px;
    }
    zerodmg-internals .tiles {
    }
    zerodmg-internals .sprites {
    }
    zerodmg-internals .bgp,
    zerodmg-internals .obj1,
    zerodmg-internals .obj2 {
      height: 16px;
    }

    zerodmg-gameboy {
      display: inline-block;
      vertical-align: top;
      position: relative;
      background: #6ab4df;
      width: 880px;
      padding: 54px 42px;
      padding-bottom: 18px;
      box-sizing: border-box;
      border: 4px outset #4489b3;
      pointer-events: none;
      user-select: none;
      border-radius: 12px;
      border-bottom-right-radius: 92px;
      z-index: 100;
    }
    .frame {
      background: #222;
      padding: 50px 60px;
      border: 4px inset #244983;
      border-radius: 12px;
      border-bottom-right-radius: 64px;
    }
    canvas {
      display: block;
      image-rendering: pixelated;
      background: #879c57;
      border: 4px inset #443;
    }
    canvas.display {
      width: 640px;
      height: 576px;
      display: block;
      margin: auto;
      background: #879c57;
      border: 4px inset #443;
    }
    button {
      font: 24px monospace;
      padding: 8px;
      min-width: 60px;
      height: 60px;
      border: 4px outset #9A9993;
      background: #393933;
      border-radius: 8px;
      margin: 4px;
      color: #CCC;
    }
    button.pressed {
      border: 4px inset #6A6963;
      background: #292923;
      color: #999;
      background: #292923;
    }
    button[disabled] {
      color: #888;
    }
    zerodmg-internals button {
      font-size: 12px;
      padding: 2px;
      height: auto;
      min-width: 40px;;
    }
    .power-light {
      position: absolute;
      left: 72px;
      top: 160px;
      width: 12px;
      height: 12px;
      border-radius: 12px;
      background: #880000;
      box-shadow: inset 1px 1px 1px 0 rgba(0, 0, 0, 0.5);
    }
    .power-light.on {
      background: red;
      box-shadow:
        inset 1px 1px 2px 0 rgba(255, 255, 255, 0.25),
        0 0 6px 3px red;
    }
    .controls {
      margin: auto;
      margin-top: 20px;
      width: 650px;
      height: 300px;
      position: relative;
    }
    .arrowleft-button {
      width: 66px;
      height: 66px;
      position: absolute;
      top: 70px;
      left: 20px;
      border-right-color: transparent;
    }
    .arrowright-button {
      width: 66px;
      height: 66px;
      position: absolute;
      top: 70px;
      left: 140px;
      border-left-color: transparent;
    }
    .arrowup-button {
      width: 66px;
      height: 66px;
      position: absolute;
      top: 10px;
      left: 80px;
      border-bottom-color: transparent;
    }
    .arrowdown-button {
      width: 66px;
      height: 66px;
      position: absolute;
      top: 130px;
      left: 80px;
      border-top-color: transparent;
    }
    .arrow-filler {
      position: absolute;
      left: 84px;
      top: 74px;
      width: 66px;
      height: 66px;
      background: #393933;
    }
    .a-button {
      position: absolute;
      top: 55px;
      right: 0px;
      width: 72px;
      height: 72px;
      border-radius: 1000px;
    }
    .b-button {
      position: absolute;
      top: 95px;
      right: 100px;
      width: 72px;
      height: 72px;
      border-radius: 1000px;
    }
    .enter-button {
      position: absolute;
      bottom: 16px;
      border-radius: 16px;
      left: calc(50% + 8px);
      width: 100px;
      padding: 0;
      height: 42px;
    }
    .space-button {
      position: absolute;
      bottom: 16px;
      border-radius: 16px;
      right: calc(50% + 8px);
      width: 100px;
      padding: 0;
      height: 42px;
    }
  </style>
  <script async type="module">
    const main = async () => {
      const gbWidth = 160;
      const gbHeight = 144;
      const display = document.querySelector('canvas.display');
      const display_g2d = display.getContext('2d');
      const bgp = document.querySelector('canvas.bgp');
      const bgp_g2d = bgp.getContext('2d');
      const tiles = document.querySelector('canvas.tiles');
      const tiles_g2d = tiles.getContext('2d');
      const bg0 = document.querySelector('canvas.background-1');
      const bg0_g2d = bg0.getContext('2d');
      const bg1 = document.querySelector('canvas.background-2');
      const bg1_g2d = bg1.getContext('2d');
      const op0 = document.querySelector('canvas.obj1');
      const op0_g2d = op0.getContext('2d');
      const op1 = document.querySelector('canvas.obj2');
      const op1_g2d = op1.getContext('2d');
      const sprites = document.querySelector('canvas.sprites');
      const sprites_g2d = sprites.getContext('2d');
      
      const powerLight = document.querySelector('.power-light');
      
      const twoBitStyle = () => {
          // our anti-aliased text has too many shades.
          // cut each colour channel down to two bits.
          let data = display_g2d.getImageData(0, 0, gbWidth, gbHeight);
          for (let i = 0; i < data.data.length; i++) {
            data.data[i] = ((data.data[i] & (128 + 64)) >> 6) * (1 + 4 + 16 + 64);
          }
          display_g2d.putImageData(data, 0, 0);
      }


      display_g2d.fillStyle = 'rgba(0, 0, 0, 0.75)'

      display_g2d.font = "bold 36px monospace";
      display_g2d.fillText("0dmg", 16.5, 64.5);

      twoBitStyle();
      await sleep(125);

      display_g2d.font = "bold 12px monospace";
      display_g2d.fillText("connecting...", 24.5, 86.5);

      twoBitStyle();
      await sleep(375);

      
      const onKeyUpDown = keyboardEvent => {
        if (keyboardEvent.ctrlKey || keyboardEvent.metaKey) {
          // ignore control-presses
          return;
        }
        keyboardEvent.preventDefault();
        keyboardEvent.stopPropagation();
        
        const el = document.querySelector(`button.${CSS.escape(keyboardEvent.key.toLowerCase().replace(' ', 'space'))}-button`);
        
        if (el) {
          if (event.type == 'keydown') {
            el.classList.add('pressed');
            fetch(`/key/down/${keyboardEvent.key.toLowerCase()}`);
          } else {
            el.classList.remove('pressed');
            fetch(`/key/up/${keyboardEvent.key.toLowerCase()}`);
          }
        }
      };

      document.addEventListener('keydown', onKeyUpDown);
      document.addEventListener('keyup', onKeyUpDown);

      let targetInterval = 1000 / 60;
      let lastStart = 0;
      while (true) {
        let bytes;
        lastStart = Date.now();
        try {
          let image = new Image();
          let p = new Promise((resolve, reject) => {
            image.onload = resolve;
            image.onerror = reject;
          });
          image.src = `/output.png`;
          await p;
          let y = 0;
          display_g2d.clearRect(0, 0, 0xFFFF, 0xFFFF);
          display_g2d.drawImage(image, 0, y, image.width, image.height);
          tiles_g2d.clearRect(0, 0, 0xFFFF, 0xFFFF);
          tiles_g2d.drawImage(image, 0, y -= display.height, image.width, image.height);
          bgp_g2d.clearRect(0, 0, 0xFFFF, 0xFFFF);
          bgp_g2d.drawImage(image, 0, y -= tiles.height, image.width, image.height);
          op0_g2d.clearRect(0, 0, 0xFFFF, 0xFFFF);
          op0_g2d.drawImage(image, 0, y -= bgp.height, image.width, image.height);
          op1_g2d.clearRect(0, 0, 0xFFFF, 0xFFFF);
          op1_g2d.drawImage(image, 0, y -= op0.height, image.width, image.height);
          bg0_g2d.clearRect(0, 0, 0xFFFF, 0xFFFF);
          bg0_g2d.drawImage(image, 0, y -= op1.height, image.width, image.height);
          bg1_g2d.clearRect(0, 0, 0xFFFF, 0xFFFF);
          bg1_g2d.drawImage(image, 0, y -= bg0.height, image.width, image.height);
          sprites_g2d.clearRect(0, 0, 0xFFFF, 0xFFFF);
          sprites_g2d.drawImage(image, 0, y -= bg1.height, image.width, image.height);
          powerLight.classList.add('on');
        } catch (error) {
          powerLight.classList.remove('on');
          console.error(error);
        }
        let targetNextStart = lastStart + targetInterval;
        let now = Date.now();
        if (now < targetNextStart) {
          await sleep(targetNextStart - now);
        }
      }
    }

    const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

    main();
  </script>
</body>
</html>
